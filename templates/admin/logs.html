{% extends "layout.html" %}

{% block title %}Event Logs - QMS{% endblock %}

{% block header_button %}
<div class="flex gap-4">
    <a href="{{ url_for('logout') }}" class="btn btn-danger text-sm">Logout</a>
</div>
{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{{ url_for('admin_events') if user['role'] == 'admin' else url_for('superadmin_dashboard') }}"
        class="text-blue-400 hover:text-blue-300 hover:underline">&larr; Back to Dashboard</a>
    <h2 class="text-3xl font-semibold mt-2 text-gray-100">Event Logs: <span class="text-blue-300">{{ event['event_name']
            }}</span></h2>
</div>

<div class="card p-6 md:p-8">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h3 class="text-2xl font-semibold text-white">Processed Logs</h3>
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 text-gray-300" title="Queue Status">
                <i data-lucide="database" class="w-5 h-5 cursor-pointer"></i>
                <span id="queue-status-light" class="w-3 h-3 bg-gray-400 rounded-full transition-all"></span>
                <span class="text-sm">Queue: <b id="queue-size" class="font-mono text-lg text-white">...</b></span>
            </div>
            <div class="flex items-center gap-2 text-gray-300" title="Logs Processed">
                <i data-lucide="check-circle" class="w-5 h-5" style="color: var(--cyber-green);"></i>
                <span class="text-sm">Processed: <b id="processed-count" class="font-mono text-lg text-white">{{
                        log_count }}</b></span>
            </div>
        </div>
    </div>
    <div class="mb-5">
        <input type="text" id="logSearch" onkeyup="filterLogs()" placeholder="Search logs by any field..."
            class="w-full px-4 py-3 form-input">
    </div>
    <div class="overflow-x-auto rounded-lg border border-gray-700">
        <table class="min-w-full divide-y divide-gray-700 dark-table">
            <thead>
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Timestamp</th>
                    {% for field in fields %}
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">{{ field['field_label']
                        }}</th>
                    {% endfor %}
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="log-display">
                {% if logs %}
                {% for log in logs %}
                <tr class="log-row" data-log-id="{{ log['log_id'] }}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm">{{ log['timestamp'] | timestamp_format }}</td>
                    {% for field in fields %}
                    <td class="px-6 py-4 whitespace-nowrap text-sm data-cell">
                        {{ log['data'].get(field['field_label'], 'N/A') }}
                    </td>
                    {% endfor %}
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <form action="{{ url_for('delete_log', log_id=log['log_id'], event_id=event['event_id']) }}"
                            method="POST">
                            <button type="submit"
                                class="text-red-400 hover:text-red-300 text-sm font-medium hover:underline">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr id="no-logs-row">
                    <td colspan="{{ fields | length + 2 }}" class="px-6 py-10 text-center text-gray-400">No logs
                        processed yet.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const FIELDS = {{ fields | tojson }};
    const EVENT_ID = {{ event['event_id'] }};
    let lastLogId = 0;

    function fetchQueueSize() {
        fetch('/queue_status')
            .then(response => response.json())
            .then(data => {
                const queueSizeEl = document.getElementById('queue-size');
                const queueStatusLightEl = document.getElementById('queue-status-light');
                if (!queueSizeEl || !queueStatusLightEl) return;
                queueSizeEl.textContent = data.size;
                if (data.size > 0) {
                    queueStatusLightEl.className = 'w-3 h-3 bg-yellow-500 rounded-full animate-pulse';
                    queueStatusLightEl.title = "Processing queue...";
                } else {
                    queueStatusLightEl.className = 'w-3 h-3 bg-cyber-green rounded-full shadow-cyber-green';
                    queueStatusLightEl.title = "Queue empty.";
                }
            });
    }

    function createLogRowHTML(log) {
        let dataCells = '';
        FIELDS.forEach(field => {
            const value = log.data[field.field_label] || 'N/A';
            const escapedValue = String(value).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            dataCells += `<td class="px-6 py-4 whitespace-nowrap text-sm data-cell">${escapedValue}</td>`;
        });

        // Use standard URL construction if possible, or relative path
        const deleteUrl = `/admin/log/delete/${log.log_id}/${EVENT_ID}`;

        return `
        <tr class="log-row log-row-new" data-log-id="${log.log_id}">
            <td class="px-6 py-4 whitespace-nowrap text-sm">${log.formatted_timestamp}</td>
            ${dataCells}
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                <form action="${deleteUrl}" method="POST">
                    <button type="submit" class="text-red-400 hover:text-red-300 text-sm font-medium hover:underline">Delete</button>
                </form>
            </td>
        </tr>`;
    }

    async function fetchNewLogs() {
        const firstRow = document.querySelector('#log-display .log-row');
        if (firstRow) {
            lastLogId = parseInt(firstRow.dataset.logId) || 0;
        }

        try {
            const response = await fetch(`/api/event/${EVENT_ID}/logs?since=${lastLogId}`);
            if (!response.ok) return;
            const data = await response.json();
            const logs = data.logs;
            if (logs.length > 0) {
                const tableBody = document.getElementById('log-display');
                const noLogsRow = document.getElementById('no-logs-row');
                const processedCountEl = document.getElementById('processed-count');
                if (noLogsRow) noLogsRow.style.display = 'none';

                // We want to PREPEND new logs, but if lastLogId logic is "since", usually means newer than top?
                // The original code used insertAdjacentHTML('afterbegin', ...) which puts it at the TOP.
                // It assumes logs are returned in ascending or descending?
                // Logic: "since=LAST_SEEN_ID". If API returns newer logs, they should go on top.
                // But usually DB IDs increase. If we fetch log_id > 100, we get 101, 102.
                // If we put 101, 102 at 'afterbegin', 102 will be above 101 if we iterate normally?
                // Or we iterate the array. If array is [101, 102], and we append 101 then 102 to top -> 102, 101.
                // Let's assume the API returns sorted.

                logs.forEach(log => {
                    const newRowHTML = createLogRowHTML(log);
                    tableBody.insertAdjacentHTML('afterbegin', newRowHTML);
                });

                if (processedCountEl) {
                    const currentCount = parseInt(processedCountEl.textContent) || 0;
                    processedCountEl.textContent = currentCount + logs.length;
                }
            }
        } catch (e) {
            console.error("Error fetching logs:", e);
        }
    }
    setInterval(() => {
        fetchQueueSize();
        fetchNewLogs();
    }, 2500);
    fetchQueueSize();

    function filterLogs() {
        let input, filter, tbody, tr, td, i, txtValue;
        input = document.getElementById("logSearch");
        filter = input.value.toUpperCase();
        tbody = document.getElementById("log-display");
        tr = tbody.getElementsByClassName("log-row");
        let noLogsRow = document.getElementById("no-logs-row");
        let visibleCount = 0;

        for (i = 0; i < tr.length; i++) {
            // Check all cells
            td = tr[i].getElementsByTagName("td");
            let rowText = "";
            for (let j = 0; j < td.length - 1; j++) { // Skip actions column
                if (td[j]) {
                    rowText += td[j].textContent || td[j].innerText;
                }
            }
            if (rowText.toUpperCase().indexOf(filter) > -1) {
                tr[i].classList.remove("hidden");
                visibleCount++;
            } else {
                tr[i].classList.add("hidden");
            }
        }
        if (noLogsRow) {
            if (visibleCount === 0 && tr.length > 0) {
                noLogsRow.classList.remove("hidden");
                noLogsRow.getElementsByTagName("td")[0].textContent = "No logs match your search.";
                noLogsRow.style.display = 'table-row';
            } else if (tr.length === 0) {
                noLogsRow.classList.remove("hidden");
                noLogsRow.getElementsByTagName("td")[0].textContent = "No logs processed yet.";
                noLogsRow.style.display = 'table-row';
            } else {
                noLogsRow.style.display = 'none';
            }
        }
    }
</script>
{% endblock %}